<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Web Du Lịch</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .hero-title {
            font-size: 2.2em;
            color: #ffffff;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            line-height: 1.3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            -webkit-text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            -moz-text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .sidebar {
            width: 300px;
            height: 100vh;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: fixed;
            right: -350px;
            top: 0;
            transition: right 0.3s ease, visibility 0.3s, opacity 0.3s;
            z-index: 999;
            overflow-y: auto;
            visibility: hidden;
            opacity: 0;
        }

        .sidebar.active {
            right: 0;
            visibility: visible;
            opacity: 1;
        }

        .user-header {
            padding: 20px;
            background: linear-gradient(to right, #c19a6b, #deb887);
            color: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-header h2 {
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .user-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: background-color 0.3s;
        }

        .menu-item:hover {
            background-color: #f0f0f0;
        }

        .menu-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .menu-item.active {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .points {
            display: flex;
            align-items: center;
            color: #333;
            padding: 15px;
            margin-bottom: 20px;
        }

        .points i {
            margin-right: 15px;
            color: #4a90e2;
        }

        .new-tag {
            background-color: #ffd700;
            color: black;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .logout-btn {
            margin-top: auto;
            color: #ff4444;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }

        .overlay.active {
            display: block;
        }

        #admin-link {
            cursor: pointer;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            background: #000;
            transition: background-color 0.3s;
        }

        #admin-link:hover {
            background: #333;
        }
    </style>
</head>
<body>
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar">
        <div class="user-header">
            <h2 id="sidebar-user-name">V&ocirc;circ; sắc Hoa</h2>
            <p>Bạn là thành viên Bronze Priority</p>
        </div>

        <div class="points">
            <i class="fas fa-coins"></i>
            <span id="user-points">0 Điểm</span>
        </div>

        <a href="edit.html" class="menu-item">
            <i class="fas fa-user"></i>
            Chỉnh sửa hồ sơ
          </a>
        <a href="my_orders.html" class="menu-item" onclick="handleMenuClick('orders')"> 
            <i class="fas fa-box"></i>
            Đơn hàng của tôi
        </a>
   
        <a href="#" class="menu-item logout-btn" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i>
            Đăng xuất
        </a>
    </div>

    <header>
        <h1>
            <a href="about us.HTML"> <img src="images/image1.png" alt = "TrungLH Travel" width="120"></a>
        </h1>
        <nav>
            <ul>
                <li><a id="user-nav-link" onclick="toggleSidebar()">Tài khoản</a></li>
                <li><a id="balance-link">SỐ DƯ</a></li>
                <li><a href="flight_booking.html">Đặt Vé Máy Bay</a></li>
                <li><a href="hotel_booking.html">Đặt Khách Sạn</a></li>
                <li><a href="payment.html">Nạp tiền</a></li>
            </ul>
        </nav>
    </header>
    
    <section class="hero">
        <h2 class="hero-title">TRẢI NGHIỆM CÁC DỊCH VỤ DU LỊCH ĐỘC ĐÁO CÙNG TRUNGLH TRAVEL</h2>
        
        <div class="search-bar">
            <input type="text" placeholder="Nhập điểm đến...">
            <button>Tìm kiếm ngay</button>
        </div>
    </section>
    
    <h3>Đặt Combo Du Lịch Với Giá Ưu Đãi Ngay</h3>
   
    <section class="combo-container" id="combo-container">
        <!-- Tour cards will be dynamically loaded here -->
    </section>
    
    <h4>
         
    </h4>
    
    
        <footer>
            <div class="footer-container">
                <div class="footer-logo">
                  <a href="about us.HTML"> <img src="images/image1.png" alt = "TrungLH Travel" width="150"></a>
                </div>
                <div class="footer-social">
                    <a href="https://x.com/TravelTrungLH"><img src="images/x-icon.png" alt="X"></a>
                    <a href="#"><img src="images/instagram-icon.png" alt="Instagram"></a>
                    <a href="https://youtu.be/xvFZjo5PgG0"><img src="images/youtube-icon.png" alt="YouTube"></a>
                    <a href="#"><img src="images/linkedin-icon.png" alt="LinkedIn"></a>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h4>Về chúng tôi</h4>
                        <ul>
                            <li><a href="#">Cách đặt chỗ</a></li>
                            <li><a href="#">Liên hệ chúng tôi</a></li>
                            <li><a href="#">Trợ giúp</a></li>
                            <li><a href="#">Tuyển dụng</a></li>
                            <li><a href="#">Giới thiệu</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h4>Sản phẩm</h4>
                        <ul>
                            <li><a href="#">Khách sạn</a></li>
                            <li><a href="#">Vé máy bay</a></li>
                            <li><a href="#">Vé xe khách</a></li>
                            <li><a href="#">Vé tàu hỏa</a></li>
                            <li><a href="#">Collaboration feats</a></li>
                            <li><a href="#">Design process</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h4>Khác</h4>
                        <ul>
                            <li><a href="#">Blog</a></li>
                            <li><a href="#">Best practices</a></li>
                            <li><a href="#">Colors</a></li>
                            <li><a href="#">Color wheel</a></li>
                            <li><a href="#">Support</a></li>
                            <li><a href="#">Developers</a></li>
                            <li><a href="#">Resource library</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
        
   
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        async function showBalance() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('Bạn cần đăng nhập để xem số dư.');
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                     alert('Phiên đăng nhập đã hết hạn hoặc không hợp lệ. Vui lòng đăng nhập lại.');
                     localStorage.removeItem('userToken');
                     localStorage.removeItem('userData');
                     localStorage.removeItem('userName');
                     window.location.href = 'login.html';
                     return;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }

                const userData = await response.json();
                const formattedBalance = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(userData.balance);
                alert(`Số dư của bạn là: ${formattedBalance}`);

            } catch (error) {
                console.error('Lỗi khi lấy số dư:', error);
                alert(`Không thể lấy số dư: ${error.message}`);
            }
        }

        function handleMenuClick(sectionId) {
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked menu item
            event.currentTarget.classList.add('active');

            // Hide the sidebar
            toggleSidebar();
        }

        function handleLogout() {
            // Hide the sidebar first
            toggleSidebar();
            
            // Then perform logout after a small delay
            setTimeout(() => {
                localStorage.removeItem('userToken');
                localStorage.removeItem('userData');
                localStorage.removeItem('userName');
                window.location.href = 'index.html';
            }, 300); // Wait for sidebar animation to complete
        }

        // Fetch and display tours
        // Fetch và hiển thị các tour
async function loadTours() {
    try {
        const response = await fetch('/api/tours');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const tours = await response.json();
        const comboContainer = document.getElementById('combo-container');
        comboContainer.innerHTML = ''; // Xóa nội dung cũ

        if (tours.length === 0) {
            comboContainer.innerHTML = '<p>Không có tour nào.</p>';
            return;
        }

        tours.forEach(tour => {
            console.log('------------------------------');
            console.log('Tên tour:', tour.name);
            console.log('Ảnh (tour.images):', tour.images);

            let imageUrl = '/images/image1.png'; // fallback

            if (Array.isArray(tour.images) && tour.images.length > 0 && typeof tour.images[0] === 'string') {
                // Loại bỏ dấu / nếu có để tránh lỗi //images
                imageUrl = `/${tour.images[0].replace(/^\/+/, '')}`;
            }

            console.log('URL ảnh sẽ dùng:', imageUrl);

            const tourCard = document.createElement('div');
            tourCard.classList.add('tour-card');
            tourCard.onclick = () => {
                window.location.href = `tour_details.html?id=${tour._id}`;
            };

            // Format giá
            const formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(tour.price);

            tourCard.innerHTML = `
                <img src="${imageUrl}" alt="${tour.name}" onerror="this.src='/images/image1.png'">
                <div class="tour-info">
                    <h3>${tour.name}</h3>
                    <p>${tour.duration.days} ngày ${tour.duration.nights} đêm</p>
                    <p><strong>${tour.destination}</strong></p>
                    <p>${tour.description?.substring(0, 100) || ''}...</p>
                    <p class="price">${formattedPrice}</p>
                </div>
            `;
            comboContainer.appendChild(tourCard);
        });

    } catch (error) {
        console.error('Lỗi khi tải danh sách tour:', error);
        const comboContainer = document.getElementById('combo-container');
        comboContainer.innerHTML = '<p>Lỗi khi tải danh sách tour. Vui lòng thử lại sau.</p>';
    }
}

        // Check if user is logged in and display their name
        document.addEventListener('DOMContentLoaded', function() {
            const userName = localStorage.getItem('userName');
            const sidebarUserName = document.getElementById('sidebar-user-name');
            const userNavLink = document.getElementById('user-nav-link');
            
            if (userName) {
                sidebarUserName.textContent = userName;
                userNavLink.textContent = userName;
            } else {
                // If not logged in, redirect to login page, unless on index.html or register.html
                if (!window.location.pathname.endsWith('index.html') && !window.location.pathname.endsWith('register.html')) {
                    window.location.href = 'login.html';
                }
            }
            loadTours(); // Load tours when DOM is ready

            const balanceLink = document.getElementById('balance-link');
            if (balanceLink) {
                balanceLink.addEventListener('click', showBalance);
            }
        });
    </script>
</body>
</html>
