<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t V√© M√°y Bay</title>
    <link rel="stylesheet" href="booking styles.css">
</head>
<body>
    <div class="container">
        <h1 class="title">ƒê·∫∑t V√© M√°y Bay</h1>

        <div class="card">
            <h2>Th√¥ng tin chuy·∫øn bay</h2>
            <div class="search-container">
                <input type="text" id="from" placeholder="ƒêi·ªÉm ƒëi" list="location-suggestions" autocomplete="off">
                <input type="text" id="to" placeholder="ƒêi·ªÉm ƒë·∫øn" list="location-suggestions" autocomplete="off">
                <datalist id="location-suggestions">
                    <option value="Ho Chi Minh City">
                    <option value="Hanoi">
                    <option value="Da Nang">
                    <option value="Nha Trang">
                    <option value="Hue">
                </datalist>
            </div>
            <input type="date" id="flight-date">
            <select id="class">
                <option value="economy">Ph·ªï th√¥ng</option>
                <option value="business">Th∆∞∆°ng gia</option>
            </select>
            <button onclick="searchFlights()">T√¨m chuy·∫øn bay</button>
        </div>

        <div id="flight-results" class="card hidden">
            <h2>K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
            <div id="flights-list"></div>
        </div>

        <p><a href="#" onclick="navigateHome()">Quay l·∫°i trang ch·ªß</a> | <a href="hotel_booking.html">ƒê·∫∑t kh√°ch s·∫°n</a></p>
    </div>

    <script>
        function navigateHome() {
            const userToken = localStorage.getItem('userToken');
            if (userToken) {
                window.location.href = 'Home page.HTML';
            } else {
                window.location.href = 'index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const userToken = localStorage.getItem('userToken');
            if (!userToken) {
                window.location.href = 'login.html';
            }

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('flight-date').min = today;
        });

        async function searchFlights() {
    const from = document.getElementById('from').value;
    const to = document.getElementById('to').value;
    const date = document.getElementById('flight-date').value;
    const flightClass = document.getElementById('class').value;

    if (!from || !to || !date) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin chuy·∫øn bay.");
        return;
    }

    if(date < new Date().toISOString().split('T')[0]) {
        alert("Ng√†y bay kh√¥ng h·ª£p l·ªá.");
        return;
    }

    const resultsSection = document.getElementById('flight-results');
    const flightsList = document.getElementById('flights-list');
    flightsList.innerHTML = '<p>ƒêang t√¨m ki·∫øm chuy·∫øn bay...</p>';
    resultsSection.style.display = 'block';

    console.log("üîç T√¨m ki·∫øm:", { from, to, date, flightClass });

    try {
        const response = await fetch(`http://localhost:5500/api/flights/search?departure=${encodeURIComponent(from)}&arrival=${encodeURIComponent(to)}&date=${date}&class=${flightClass}`);
        const flights = await response.json();

        console.log("üì¶ K·∫øt qu·∫£ nh·∫≠n ƒë∆∞·ª£c:", flights);
        if (!response.ok) {
            throw new Error(flights.message || 'L·ªói khi t√¨m ki·∫øm chuy·∫øn bay');
        }

        displayFlights(flights);
    } catch (error) {
        flightsList.innerHTML = `<p class="error">${error.message}</p>`;
    }
}

        function displayFlights(flights) {
            const flightsList = document.getElementById('flights-list');
            if (flights.length === 0) {
                flightsList.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y chuy·∫øn bay ph√π h·ª£p.</p>';
                return;
            }

            flightsList.innerHTML = flights.map(flight => `
                <div class="flight-card">
                    <h3>${flight.airline} - ${flight.flightNumber}</h3>
                    <p><strong>T·ª´:</strong> ${flight.departure.city} (${new Date(flight.departure.time).toLocaleString()})</p>
                    <p><strong>ƒê·∫øn:</strong> ${flight.arrival.city} (${new Date(flight.arrival.time).toLocaleString()})</p>
                    <p><strong>Gi√°:</strong> ${formatPrice(flight.price)} VNƒê</p>
                    <p><strong>C√≤n tr·ªëng:</strong> ${flight.availableSeats} ch·ªó</p>
                    <button onclick="bookFlight('${flight._id}')">ƒê·∫∑t v√©</button>
                </div>
            `).join('');
        }

        function formatPrice(price) {
            return price.toLocaleString('vi-VN');
        }

        async function bookFlight(flightId) {
            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t v√©');
                return;
            }

            try {
                const response = await fetch('http://localhost:5500/api/flights/book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ flightId })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'ƒê·∫∑t v√© th·∫•t b·∫°i');
                }

                alert('ƒê·∫∑t v√© th√†nh c√¥ng!');
            } catch (error) {
                alert(error.message);
            }
        }
    </script>
</body>
</html>
