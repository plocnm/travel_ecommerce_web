<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Vé Máy Bay</title>
    <link rel="stylesheet" href="booking styles.css">
</head>
<body>
    <div class="container">
        <h1 class="title">Đặt Vé Máy Bay</h1>

        <div class="card">
            <h2>Thông tin chuyến bay</h2>
            <div class="search-container">
                <input type="text" id="from" placeholder="Điểm đi" list="location-suggestions" autocomplete="off">
                <input type="text" id="to" placeholder="Điểm đến" list="location-suggestions" autocomplete="off">
                <datalist id="location-suggestions">
                    <option value="Ho Chi Minh City">
                    <option value="Hanoi">
                    <option value="Da Nang">
                    <option value="Nha Trang">
                    <option value="Hue">
                </datalist>
            </div>
            <div class="form-group">
                <label for="flight-date">Ngày bay</label>
                <input type="date" id="flight-date" title="Chọn ngày bay">
            </div>
            <div class="form-group">
                <label for="class">Hạng ghế</label>
                <select id="class" title="Chọn hạng ghế">
                    <option value="economy">Phổ thông</option>
                    <option value="business">Thương gia</option>
                </select>
            </div>
            <div class="form-group">
                <label for="passengers">Số lượng hành khách</label>
                <input type="number" id="passengers" value="1" min="1" title="Chọn số lượng hành khách">
            </div>
            <button onclick="searchFlights()">Tìm chuyến bay</button>
        </div>

        <div id="flight-results" class="card hidden">
            <h2>Kết quả tìm kiếm</h2>
            <div id="flights-list"></div>
        </div>

        <p><a href="#" onclick="navigateHome()">Quay lại trang chủ</a> | <a href="hotel_booking.html">Đặt khách sạn</a></p>
    </div>

    <script>
        function navigateHome() {
            const userToken = localStorage.getItem('userToken');
            if (userToken) {
                window.location.href = 'Home page.HTML';
            } else {
                window.location.href = 'index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const userToken = localStorage.getItem('userToken');
            if (!userToken) {
                window.location.href = 'login.html';
            }

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('flight-date').min = today;
        });

        async function searchFlights() {
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            const date = document.getElementById('flight-date').value;
            const flightClass = document.getElementById('class').value;
            const passengers = document.getElementById('passengers').value;

            if (!from || !to || !date) {
                alert("Vui lòng nhập đầy đủ thông tin chuyến bay.");
                return;
            }

            if(date < new Date().toISOString().split('T')[0]) {
                alert("Ngày bay không hợp lệ.");
                return;
            }

            const resultsSection = document.getElementById('flight-results');
            const flightsList = document.getElementById('flights-list');
            flightsList.innerHTML = '<p>Đang tìm kiếm chuyến bay...</p>';
            resultsSection.style.display = 'block';

            try {
                const response = await fetch(`http://localhost:5500/api/flights/search?departure=${encodeURIComponent(from)}&arrival=${encodeURIComponent(to)}&date=${date}&class=${flightClass}&passengers=${passengers}`);
                const flights = await response.json();

                if (!response.ok) {
                    throw new Error(flights.message || 'Lỗi khi tìm kiếm chuyến bay');
                }

                displayFlights(flights, flightClass, parseInt(passengers));
            } catch (error) {
                flightsList.innerHTML = `<p class="error">${error.message}</p>`;
            }
        }

        function displayFlights(flights, flightClass, passengerCount) {
            const flightsList = document.getElementById('flights-list');
            if (flights.length === 0) {
                flightsList.innerHTML = '<p>Không tìm thấy chuyến bay phù hợp.</p>';
                return;
            }

            flightsList.innerHTML = flights.map(flight => `
                <div class="flight-card">
                    <h3>${flight.airline} - ${flight.flightNumber}</h3>
                    <p><strong>Từ:</strong> ${flight.departure.city} (${new Date(flight.departure.time).toLocaleString()})</p>
                    <p><strong>Đến:</strong> ${flight.arrival.city} (${new Date(flight.arrival.time).toLocaleString()})</p>
                    <p><strong>Giá:</strong> ${formatPrice(flight.price)} VNĐ</p>
                    <p><strong>Còn trống:</strong> ${flight.availableSeats} chỗ</p>
                    <button onclick="bookFlight('${flight._id}', ${passengerCount}, '${flightClass}')">Đặt vé</button>
                </div>
            `).join('');
        }

        function formatPrice(price) {
            return price.toLocaleString('vi-VN');
        }

        async function bookFlight(flightId, passengerCount, flightClass) {
            const token = localStorage.getItem('userToken');
            if (!token) {
                alert('Vui lòng đăng nhập để đặt vé');
                return;
            }

            // Create a dummy passengers array
            const passengersArray = Array(passengerCount).fill({}).map((_, index) => ({ name: `Passenger ${index + 1}` }));

            try {
                const response = await fetch('http://localhost:5500/api/flights/book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ flightId, passengers: passengersArray, class: flightClass })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Đặt vé thất bại');
                }

                alert(result.message);
                if (result.redirectToPayment) {
                    window.location.href = 'payment.html';
                } else {
                    window.location.href = 'Home page.HTML';
                }
            } catch (error) {
                alert(error.message);
            }
        }
    </script>
</body>
</html>
